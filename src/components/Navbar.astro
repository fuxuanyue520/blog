---
import { Icon } from 'astro-icon/components';
---

<nav class="fixed top-0 left-0 w-full h-16 lg:h-20 bg-dark-900/80 backdrop-blur-xl z-50 border-b border-white/5 transition-all duration-300" transition:persist>
  <div class="max-w-[1600px] mx-auto h-full px-4 md:px-6 lg:px-8 flex items-center justify-between">
    
    <div class="flex items-center gap-8 lg:gap-10">
        <!-- Logo -->
        <a href="/" class="flex items-center gap-3 group">
          <div class="w-10 h-10 lg:w-12 lg:h-12 rounded-full overflow-hidden border-2 border-primary-500/50 group-hover:border-primary-500 group-hover:shadow-[0_0_15px_rgba(6,182,212,0.4)] transition-all duration-300">
            <img src="/avatar.jpg" alt="Logo" class="w-full h-full object-cover" />
          </div>
          <span class="text-xl lg:text-2xl font-serif font-bold text-gray-100 group-hover:text-primary-500 transition-colors tracking-wide">秋兰以为佩</span>
        </a>

        <!-- Desktop Menu (Left Aligned) -->
        <div class="hidden md:flex items-center gap-6 lg:gap-8">
          <a href="/" class="text-base lg:text-lg font-medium text-gray-300 hover:text-primary-400 transition-colors flex items-center gap-2 relative group">
            <Icon name="ri:home-4-line" class="text-xl lg:text-2xl" />
            <span>主页</span>
            <span class="absolute -bottom-1.5 left-0 w-0 h-0.5 bg-primary-500 transition-all group-hover:w-full"></span>
          </a>
          <a href="/archive" class="text-base lg:text-lg font-medium text-gray-300 hover:text-primary-400 transition-colors flex items-center gap-2 relative group">
            <Icon name="ri:archive-line" class="text-xl lg:text-2xl" />
            <span>归档</span>
            <span class="absolute -bottom-1.5 left-0 w-0 h-0.5 bg-primary-500 transition-all group-hover:w-full"></span>
          </a>
          <a href="/about" class="text-base lg:text-lg font-medium text-gray-300 hover:text-primary-400 transition-colors flex items-center gap-2 relative group">
            <Icon name="ri:user-smile-line" class="text-xl lg:text-2xl" />
            <span>关于</span>
            <span class="absolute -bottom-1.5 left-0 w-0 h-0.5 bg-primary-500 transition-all group-hover:w-full"></span>
          </a>
        </div>
    </div>

    <!-- Right Actions -->
    <div class="flex items-center gap-4">
      <!-- Wallpaper Toggle Button (Only visible on non-post pages) -->
      {
        !Astro.url.pathname.startsWith('/posts/') && (
          <button id="wallpaper-toggle" class="relative group flex items-center justify-center w-10 h-10 rounded-full hover:bg-white/5 transition-all duration-300" aria-label="切换模式">
            <div class="relative w-6 h-6 flex items-center justify-center">
               <!-- Icon for Normal Mode (Click to enter Wallpaper Mode) - Shows "Landscape/View" -->
               <Icon name="ri:landscape-line" id="icon-normal" class="absolute inset-0 w-full h-full text-gray-400 group-hover:text-primary-400 transition-all duration-300 transform scale-100 opacity-100" />
               <!-- Icon for Wallpaper Mode (Click to exit Wallpaper Mode) - Shows "Article/Content" -->
               <Icon name="ri:article-line" id="icon-wallpaper" class="absolute inset-0 w-full h-full text-primary-500 transition-all duration-300 transform scale-0 opacity-0" />
            </div>
            
            <!-- Tooltip -->
            <span id="wallpaper-tooltip" class="absolute top-full mt-2 right-0 bg-dark-800 border border-white/10 text-gray-200 text-xs px-3 py-1.5 rounded-lg opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none whitespace-nowrap shadow-xl backdrop-blur-md z-50">
              进入沉浸模式
            </span>
          </button>
        )
      }

      <!-- Mobile Menu Button -->
      <button id="mobile-menu-btn" class="md:hidden text-gray-300 hover:text-primary-500 focus:outline-none p-1">
        <Icon name="ri:menu-4-line" class="text-2xl" id="menu-icon-open" />
        <Icon name="ri:close-line" class="text-2xl hidden" id="menu-icon-close" />
      </button>
    </div>
  </div>

  <!-- Mobile Menu Dropdown -->
  <div id="mobile-menu" class="fixed top-16 left-0 w-full bg-dark-900/95 backdrop-blur-xl border-b border-white/5 shadow-2xl transform -translate-y-[150%] transition-transform duration-300 md:hidden flex flex-col items-center py-6 gap-6 z-40">
      <a href="/" class="text-lg font-medium text-gray-300 hover:text-primary-400 transition-colors flex items-center gap-3 w-full justify-center py-2 active:bg-white/5">
        <Icon name="ri:home-4-line" class="text-xl" />
        <span>主页</span>
      </a>
      <a href="/archive" class="text-lg font-medium text-gray-300 hover:text-primary-400 transition-colors flex items-center gap-3 w-full justify-center py-2 active:bg-white/5">
        <Icon name="ri:archive-line" class="text-xl" />
        <span>归档</span>
      </a>
      <a href="/about" class="text-lg font-medium text-gray-300 hover:text-primary-400 transition-colors flex items-center gap-3 w-full justify-center py-2 active:bg-white/5">
        <Icon name="ri:user-smile-line" class="text-xl" />
        <span>关于</span>
      </a>
  </div>
</nav>

<script>
  // Runs on initial load and after every navigation
  document.addEventListener('astro:page-load', () => {
    // Mobile Menu Logic
    const menuBtn = document.getElementById('mobile-menu-btn');
    const mobileMenu = document.getElementById('mobile-menu');
    const menuIconOpen = document.getElementById('menu-icon-open');
    const menuIconClose = document.getElementById('menu-icon-close');
    let isMenuOpen = false;

    if (menuBtn && mobileMenu && menuIconOpen && menuIconClose) {
      // Reset state on page load
      isMenuOpen = false;
      mobileMenu.classList.add('-translate-y-[150%]');
      menuIconOpen.classList.remove('hidden');
      menuIconClose.classList.add('hidden');

      // Remove any existing listeners to prevent duplicates if elements were cached but script reruns
      // (Though with astro:page-load we usually get fresh elements or need to re-attach)
      const toggleMenu = () => {
        isMenuOpen = !isMenuOpen;
        if (isMenuOpen) {
          mobileMenu.classList.remove('-translate-y-[150%]');
          menuIconOpen.classList.add('hidden');
          menuIconClose.classList.remove('hidden');
        } else {
          mobileMenu.classList.add('-translate-y-[150%]');
          menuIconOpen.classList.remove('hidden');
          menuIconClose.classList.add('hidden');
        }
      };
      
      // Clean up old listener if we attach to a persisting element (nav persists)
      // But button is inside nav...
      menuBtn.onclick = toggleMenu; // Simple override
    }

    // Wallpaper Toggle Logic
    const wallpaperBtn = document.getElementById('wallpaper-toggle');
    const iconNormal = document.getElementById('icon-normal');
    const iconWallpaper = document.getElementById('icon-wallpaper');
    const tooltip = document.getElementById('wallpaper-tooltip');
    
    if (wallpaperBtn && iconNormal && iconWallpaper) {
      
      const updateIconState = () => {
        const isWallpaperMode = document.body.classList.contains('wallpaper-mode');
        if (isWallpaperMode) {
          // Show Wallpaper Icon (Active state - Click to exit)
          iconNormal.classList.remove('scale-100', 'opacity-100');
          iconNormal.classList.add('scale-0', 'opacity-0');
          
          iconWallpaper.classList.remove('scale-0', 'opacity-0');
          iconWallpaper.classList.add('scale-100', 'opacity-100');
          
          // Update Tooltip
          if (tooltip) tooltip.textContent = "退出沉浸模式";
        } else {
          // Show Normal Icon (Inactive state - Click to enter)
          iconNormal.classList.remove('scale-0', 'opacity-0');
          iconNormal.classList.add('scale-100', 'opacity-100');
          
          iconWallpaper.classList.remove('scale-100', 'opacity-100');
          iconWallpaper.classList.add('scale-0', 'opacity-0');
          
          // Update Tooltip
          if (tooltip) tooltip.textContent = "进入沉浸模式";
        }
      };

      // Initial check
      updateIconState();

      // Click Handler
      wallpaperBtn.onclick = () => {
        document.dispatchEvent(new CustomEvent('toggle-wallpaper'));
      };

      // Observe Body Class Changes to update icon sync
      const observer = new MutationObserver(() => {
        updateIconState();
      });
      observer.observe(document.body, { attributes: true, attributeFilter: ['class'] });
    }
  });
</script>
