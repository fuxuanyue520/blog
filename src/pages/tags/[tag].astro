---
import PageLayout from '../../layouts/PageLayout.astro';
import ArticleCard from '../../components/ArticleCard.astro';
import { getCollection } from 'astro:content';
import { Icon } from 'astro-icon/components';

export async function getStaticPaths() {
  const allPosts = await getCollection('posts');
  // Handle optional tags, filter out undefined/null, and flatten
  const uniqueTags = [...new Set(allPosts.flatMap(post => post.data.tags || []))];

  return uniqueTags.map(tag => {
    const filteredPosts = allPosts
      .filter(post => post.data.tags?.includes(tag))
      .sort((a, b) => new Date(b.data.publishedAt).valueOf() - new Date(a.data.publishedAt).valueOf());
    
    return {
      params: { tag },
      props: { posts: filteredPosts },
    };
  });
}

const { tag } = Astro.params;
const { posts } = Astro.props;
---

<PageLayout title={`标签: ${tag} - 秋兰以为佩的博客`}>
    <div class="mb-6 flex items-center justify-between">
        <h2 class="text-xl font-bold text-gray-900 dark:text-white flex items-center gap-2">
            <Icon name="ri:price-tag-3-line" class="text-primary-500" />
            标签: <span class="text-primary-500">{tag}</span>
        </h2>
    </div>
    <div class="space-y-6">
        {posts.map(post => (
            <ArticleCard article={post} />
        ))}
    </div>
</PageLayout>
