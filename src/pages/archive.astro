---
import BlogLayout from '../layouts/BlogLayout.astro';
import { getCollection } from 'astro:content';
import { formatDate } from '../utils/date';

const posts = await getCollection('posts', ({ data }) => {
  return import.meta.env.PROD ? data.draft !== true : true;
});

const sortedPosts = posts.sort((a, b) => b.data.publishedAt.valueOf() - a.data.publishedAt.valueOf());

const groupedPosts = sortedPosts.reduce((acc, post) => {
  const year = post.data.publishedAt.getFullYear();
  if (!acc[year]) {
    acc[year] = [];
  }
  acc[year].push(post);
  return acc;
}, {} as Record<number, typeof posts>);

const years = Object.keys(groupedPosts).map(Number).sort((a, b) => b - a);
---

<BlogLayout title="归档 - 轩仔的博客" description="文章归档，按时间回顾历史文章。">
  <div class="space-y-12">
    <header>
      <h1 class="text-3xl font-bold text-white mb-4">文章归档</h1>
      <div class="h-1 w-20 bg-primary-500 rounded-full"></div>
    </header>

    <div class="space-y-12">
      {years.map((year) => (
        <section>
          <h2 class="text-6xl font-bold text-dark-700/50 mb-8 relative">
            {year}
            <span class="absolute top-1/2 -translate-y-1/2 left-0 text-2xl text-primary-500 font-bold ml-1 opacity-0">#</span>
          </h2>
          
          <div class="space-y-8 pl-4 border-l-2 border-dark-800 ml-4">
            {groupedPosts[year].map((post) => (
              <article class="relative pl-8 group">
                <div class="absolute -left-[9px] top-2 w-4 h-4 rounded-full bg-dark-900 border-2 border-dark-700 group-hover:border-primary-500 transition-colors"></div>
                <div class="flex flex-col sm:flex-row sm:items-baseline gap-2 sm:gap-6">
                  <time datetime={post.data.publishedAt.toISOString()} class="text-sm text-gray-500 font-mono min-w-[100px]">
                    {formatDate(post.data.publishedAt, 'MMM dd')}
                  </time>
                  <h3 class="text-lg font-medium text-gray-200 group-hover:text-primary-400 transition-colors">
                    <a href={`/posts/${post.slug}`} class="focus:outline-none">
                      <span class="absolute inset-0" aria-hidden="true"></span>
                      {post.data.title}
                    </a>
                  </h3>
                </div>
              </article>
            ))}
          </div>
        </section>
      ))}
    </div>
  </div>
</BlogLayout>
