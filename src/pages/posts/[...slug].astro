---
import { getCollection } from 'astro:content';
import BlogLayout from '../../layouts/BlogLayout.astro';
import { formatDate } from '../../utils/date';
import { Clock, Calendar, Tag, ChevronLeft } from 'lucide-react';

export async function getStaticPaths() {
  const posts = await getCollection('posts');
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

const { post } = Astro.props;
const { Content, headings } = await post.render();
const { title, description, publishedAt, updatedAt, tags, readingTime } = post.data;
---

<BlogLayout title={`${title} - 轩仔的博客`} description={description}>
  <article class="relative">
    <!-- Back Link -->
    <a href="/" class="inline-flex items-center gap-2 text-sm text-gray-500 hover:text-primary-400 mb-8 transition-colors group">
      <ChevronLeft className="w-4 h-4 group-hover:-translate-x-1 transition-transform" />
      返回首页
    </a>

    <!-- Header -->
    <header class="mb-10">
      <div class="flex flex-wrap items-center gap-4 text-sm text-gray-500 mb-4">
        <span class="flex items-center gap-1.5">
          <Calendar className="w-4 h-4" />
          {formatDate(publishedAt)}
        </span>
        <span class="flex items-center gap-1.5">
          <Clock className="w-4 h-4" />
          {readingTime} min read
        </span>
      </div>

      <h1 class="text-3xl lg:text-4xl font-bold text-white mb-6 leading-tight">{title}</h1>

      <div class="flex flex-wrap gap-2">
        {tags.map((tag) => (
          <span class="flex items-center gap-1 text-xs text-primary-400 bg-primary-500/10 px-2.5 py-1 rounded-full border border-primary-500/20">
            <Tag className="w-3 h-3" />
            {tag}
          </span>
        ))}
      </div>
    </header>

    <div class="flex flex-col lg:flex-row gap-8 lg:gap-12">
      <!-- Content -->
      <div class="flex-1 min-w-0">
        <div class="prose prose-invert prose-lg max-w-none 
          prose-headings:font-bold prose-headings:text-white 
          prose-a:text-primary-400 prose-a:no-underline hover:prose-a:underline
          prose-strong:text-white
          prose-code:text-primary-300 prose-code:bg-dark-800 prose-code:px-1.5 prose-code:py-0.5 prose-code:rounded prose-code:before:content-none prose-code:after:content-none
          prose-pre:bg-dark-800 prose-pre:border prose-pre:border-dark-700
          prose-blockquote:border-l-primary-500 prose-blockquote:bg-dark-800/50 prose-blockquote:py-1 prose-blockquote:px-4 prose-blockquote:not-italic
          prose-img:rounded-xl prose-img:shadow-lg">
          <Content />
        </div>
      </div>

      <!-- TOC (Hidden on mobile, sticky on desktop) -->
      <aside class="hidden lg:block w-64 shrink-0">
        <div class="sticky top-12">
          <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-4">目录</h3>
          <ul class="space-y-2 text-sm border-l border-dark-700 pl-4">
            {headings.map((heading) => (
              <li class={`${heading.depth === 3 ? 'pl-4' : ''}`}>
                <a 
                  href={`#${heading.slug}`} 
                  class="block text-gray-500 hover:text-primary-400 transition-colors line-clamp-1"
                >
                  {heading.text}
                </a>
              </li>
            ))}
          </ul>
        </div>
      </aside>
    </div>
  </article>
</BlogLayout>
